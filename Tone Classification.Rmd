---
title: "Tone Classification"
author: "Giang Le"
date: "10/28/2021"
output:
  html_document:
    df_print: paged
  pdf_document: 
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Import and Preprocessing
Our data contains 12 voice reports from 12 recording sessions.

```{r}
# Read in all the voice reports.
dataFiles <- lapply(Sys.glob("*/channel1/acoustic_measurements_unique_*.csv"), read.csv)
dataFiles[1]
```

```{r}
## Add the following categorical predictors.
# Gender: F and M (done)
# Noise type: quiet, 78 or 90 (done)
# Single token or token in a sentence
# Syllable type 
# Tone

# Converting to DataFrames

f_1_78 <- as.data.frame(dataFiles[1])
f_1_90 <- as.data.frame(dataFiles[2])
f_1_q <- as.data.frame(dataFiles[3])

m_1_78 <- as.data.frame(dataFiles[4])
m_1_90 <- as.data.frame(dataFiles[5])
m_1_q <- as.data.frame(dataFiles[6])

m_2_78 <- as.data.frame(dataFiles[7])
#m_2_90 <- as.data.frame(dataFiles[8])
#m_2_q <- as.data.frame(dataFiles[9])

m_3_78 <- as.data.frame(dataFiles[8])
m_3_90 <- as.data.frame(dataFiles[9])
m_3_q <- as.data.frame(dataFiles[10])

# Assigning gender variable (0 for female and 1 for male)
f_1_78$gender = 0
f_1_90$gender = 0
f_1_q$gender = 0

m_1_78$gender = 1
m_1_90$gender = 1
m_1_q$gender = 1

m_2_78$gender = 1
#m_2_90$gender = 1
#m_2_q$gender = 1

m_3_78$gender = 1
m_3_90$gender = 1
m_3_q$gender = 1

# Assigning noise level
f_1_78$noise = 78
f_1_90$noise = 90
f_1_q$noise = 0

m_1_78$noise = 78
m_1_90$noise = 90
m_1_q$noise = 0

m_2_78$noise = 78
#m_2_90$noise = 90
#m_2_q$noise = 0

m_3_78$noise = 78
m_3_90$noise = 90
m_3_q$noise = 0

```

```{r}
### Concatenate all dataframes
voice_reports <- rbind(f_1_78, f_1_90, f_1_q,
                       m_1_78, m_1_90, m_1_q,
                       m_2_78, 
                       #m_2_90, m_2_q,
                       m_3_78, m_3_90, m_3_q)



## Drop intervals that don't matter
voice_reports <- voice_reports[!(endsWith(voice_reports$sound.name,"_")),]
dim(voice_reports)
mean(voice_reports$total.duration)
sd(voice_reports$total.duration)
min(voice_reports$total.duration)
max(voice_reports$total.duration)
summary(voice_reports$total.duration)
head(voice_reports,10)
```

```{r}
# Assigning if the token is single (1) or not (0).
voice_reports$single <- ifelse(grepl("single", voice_reports$sound.name), 1, 0)

# Assign syllable shapes (do later)


# Assign tone values
voice_reports$tone <- ifelse(grepl("a", voice_reports$sound.name, ignore.case=T), "A1",
                      ifelse(grepl("à", voice_reports$sound.name, ignore.case=T), "A2",
                      ifelse(grepl("á", voice_reports$sound.name, ignore.case=T), "B1",
                      ifelse(grepl("ả", voice_reports$sound.name, ignore.case=T), "C1",
                      ifelse(grepl("ã", voice_reports$sound.name, ignore.case=T), "C2",
                      ifelse(grepl("ạ", voice_reports$sound.name, ignore.case=T), "B2",
                      ifelse(grepl("ê", voice_reports$sound.name, ignore.case=T), "A1",
                      ifelse(grepl("ề", voice_reports$sound.name, ignore.case=T), "A2",
                      ifelse(grepl("ế", voice_reports$sound.name, ignore.case=T), "B1",
                      ifelse(grepl("ể", voice_reports$sound.name, ignore.case=T), "C1",
                      ifelse(grepl("ễ", voice_reports$sound.name, ignore.case=T), "C2",
                      ifelse(grepl("ệ", voice_reports$sound.name, ignore.case=T), "B2",
                      ifelse(grepl("u", voice_reports$sound.name, ignore.case=T), "A1",
                      ifelse(grepl("ù", voice_reports$sound.name, ignore.case=T), "A2",
                      ifelse(grepl("ú", voice_reports$sound.name, ignore.case=T), "B1",
                      ifelse(grepl("ủ", voice_reports$sound.name, ignore.case=T), "C1",
                      ifelse(grepl("ũ", voice_reports$sound.name, ignore.case=T), "C2",
                      ifelse(grepl("ụ", voice_reports$sound.name, ignore.case=T), "B2",
                      ifelse(grepl("ộ", voice_reports$sound.name, ignore.case=T), "B2","NA")))))))))))))))))))

# Assign phonation types
voice_reports$phonation <- ifelse(grepl("A1", voice_reports$tone, ignore.case=T), "modal",
                      ifelse(grepl("A2", voice_reports$tone, ignore.case=T), "breathy",
                      ifelse(grepl("B1", voice_reports$tone, ignore.case=T), "modal",
                      ifelse(grepl("B2", voice_reports$tone, ignore.case=T), "creaky",
                      ifelse(grepl("C1", voice_reports$tone, ignore.case=T), "creaky",
                      ifelse(grepl("C2", voice_reports$tone, ignore.case=T), "creaky","NA"))))))


# Assign creakiness or not
voice_reports$creaky <- ifelse(grepl("creaky", voice_reports$phonation, ignore.case=T), 1, 0)
head(voice_reports, 20)
```

### Checking
```{r}
# How many values are of each category
length(voice_reports$tone[voice_reports$tone == "A1"])
## [1] 574
length(voice_reports$tone[voice_reports$tone == "A2"])
## [1] 575
length(voice_reports$tone[voice_reports$tone == "B1"])
## [1] 719
length(voice_reports$tone[voice_reports$tone == "B2"])
## [1] 768
length(voice_reports$tone[voice_reports$tone == "C1"])
## [1] 575
length(voice_reports$tone[voice_reports$tone == "C2"])
## [1] 575
length(voice_reports$tone[voice_reports$tone == "NA"])
## [1] 0
```

### Convert categorical values to factors
```{r}
## Not sure if this is necessary for variables already binarily coded.
voice_reports$gender <- as.factor(voice_reports$gender)
voice_reports$noise <- as.factor(voice_reports$noise)
voice_reports$tone <- as.factor(voice_reports$tone)
voice_reports$single <- as.factor(voice_reports$single)
voice_reports$phonation <- as.factor(voice_reports$phonation)
voice_reports$creaky <- as.factor(voice_reports$creaky)

```


### Summary of current data
```{r}
summary(voice_reports)
```

### Logistic Regression on Gender
```{r}
head(voice_reports)
logit_gender = glm(gender ~ mean.F0 + total.duration + intensity +  mean.HNR, family = "binomial", data=voice_reports)
summary(logit_gender)
```

### Logistic Regression on Creaky
```{r}
logit_creaky = glm(creaky ~  mean.F0 + total.duration + intensity + spectraltilt + number.pulses + mean.HNR, family = "binomial", data=voice_reports)
summary(logit_creaky)
```

### Multinomial Regression to predict the Noise Level.
```{r}
## Use the multinom function from the nnet package (Ref: https://stats.idre.ucla.edu/r/dae/multinomial-logistic-regression/)

library("nnet")
# Use the 78 noise level as the reference level
voice_reports$noise2 <- relevel(voice_reports$noise, ref = "78")
multinom_noise <- multinom(noise2 ~ mean.F0 + total.duration + intensity + spectraltilt, data=voice_reports)
summary(multinom_noise)

# The result in general supports our predictions regarding the relationship
#between relative noise levels
# and F0, duration, intensity, etc.

# For instance,
# A one-unit increase in mean F0 is associated with the decrease in the
#log odds of quiet vs. 78 noise level in the amount of 0.0133
# A one-unit increase in mean F0 is associated with the increase in the
#log odds of 90 noise vs. 78 noise in the amount of 0.006

# A one-unit increase in duration is associated with the decrease in the
#log odds of quiet vs. 78 noise level in the amount of 5.795
# A one-unit increase in duration is associated with the increase in the
#log odds of 90 noise vs. 78 noise in the amount of 2.80

# A one-unit increase in intensity is associated with the decrease in the
#log odds of quiet vs. 78 noise level in the amount of 0.35
# A one-unit increase in intensity is associated with the increase in the
#*log odds of 90 noise vs. 78 noise in the amount of 0.24

## Giang to double check this result
# A one-unit increase in spectraltilt is associated with the decrease in the
#log odds of quiet vs. 78 noise level in the amount of 0.066
# A one-unit increase in spectraltilt is associated with the increase in the
#log odds of 90 noise vs. 78 noise in the amount of 0.011
```

### Clean up undefined values to prepare for Classification
```{r}

## Method 1: Simply drop values that are undefined in jitter and shimmer variables
voice_reports_clean <- voice_reports[!(voice_reports$jitter.local==" --undefined-- " | voice_reports$shimmer.local==" --undefined-- " ),]

# Convert two variables to numeric
voice_reports_clean$jitter.local <- as.numeric(voice_reports_clean$jitter.local)
voice_reports_clean$shimmer.local <- as.numeric(voice_reports_clean$shimmer.local)

summary(voice_reports_clean)

```

## Classification using SMV (ref https://medium.com/@ODSC/build-a-multi-class-support-vector-machine-in-r-abcdd4b7dab6)

```{r}

library(e1071)   
set.seed(777)
n <- nrow(voice_reports_clean)
ntrain <- round(n*0.75)  # 75% for training set
tindex <- sample(n, ntrain)
train <- voice_reports_clean[tindex,c("total.duration", "intensity", 
                                      "spectraltilt", "mean.F0", "jitter.local",
                                      "shimmer.local", "mean.HNR", "gender",
                                      "noise", "F1", "F2", "tone")]
test <- voice_reports_clean[-tindex,c("total.duration", "intensity",
                                      "spectraltilt", "mean.F0", "jitter.local",
                                      "shimmer.local", "mean.HNR", "gender",
                                      "noise", "F1", "F2", "tone")]

# Some factors cause any error probably due to not having the same levels between train and test?
svm_model <- svm(tone ~ total.duration + intensity + spectraltilt + mean.F0 + jitter.local
                 + shimmer.local + mean.HNR + gender + noise + F1 + F2, data=train, 
          method="C-classification", kernal="radial", 
          gamma=0.1, cost=10)

summary(svm_model)
prediction <- predict(svm_model, test)
confusion <- table(test$tone, prediction)
confusion
```

### Analysis of the F0 contours extracted from MatLab

```{r}

F0test <- read.table("f-1-78/channel1/F0.mat", sep = " ")
F0test

```
